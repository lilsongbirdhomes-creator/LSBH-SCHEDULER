<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LilSongBirdHomes Scheduler</title>
<link rel="stylesheet" href="/styles.css">
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-wrap">
  <div class="login-head">
    <h1>ğŸµ LilSongBirdHomes</h1>
    <p>Staff Scheduling System</p>
  </div>
  <div class="login-body">
    <div id="loginError" class="err-msg"></div>
    <div class="fg">
      <label>Username</label>
      <input type="text" id="username" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="fg">
      <label>Password</label>
      <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="handleLogin()">Sign In</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" class="app hidden">
  <div class="app-hdr">
    <div>
      <h1>ğŸµ LilSongBirdHomes</h1>
      <div class="sub">Logged in as: <span id="userName"></span></div>
    </div>
    <div class="hdr-right">
      <div class="badge" id="roleBadge">Staff</div>
      <button class="lo-btn" onclick="openContactDialog()">ğŸ“ Contact</button>
      <button class="lo-btn" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <div class="content">

    <!-- â•â•â• ADMIN VIEW â•â•â• -->
    <div id="adminPanel" class="hidden">
      <div class="admin-tabs">
        <button class="a-tab active" onclick="switchTab('schedule')">Schedule</button>
        <button class="a-tab" onclick="switchTab('staff')">Manage Staff</button>
        <button class="a-tab" onclick="switchTab('approvals')">
          Approvals <span id="approvalBadge" class="approval-badge hidden">0</span>
        </button>
      </div>

      <!-- SCHEDULE TAB -->
      <div id="scheduleTab" class="tab-pane active">
        <div class="schedule-toolbar">
          <button class="gen-trigger-btn" onclick="openShiftGenerator()">ğŸ—“ï¸ Shift Generator</button>
          <div class="notification-section">
            <button id="sendNotificationsBtn" class="btn-notify" onclick="sendScheduleNotifications()" disabled style="opacity:0.5;">
              ğŸ“§ Send Notifications
            </button>
            <button class="btn-clear-changes" onclick="clearScheduleChanges()">ğŸ—‘ï¸ Clear Changes</button>
          </div>
        </div>

        <!-- Calendar nav + grid live INSIDE the schedule tab for admin -->
        <div class="cal-nav">
          <div class="cal-nav-left">
            <button class="nav-arrow" onclick="navPrev()">â—„</button>
            <span class="cal-title" id="calTitle"></span>
            <button class="nav-arrow" onclick="navNext()">â–º</button>
          </div>
          <div class="view-toggle">
            <button class="v-btn active" id="vWeek" onclick="setView('week')">Week</button>
            <button class="v-btn" id="vMonth" onclick="setView('month')">Month</button>
          </div>
        </div>
        <div class="cal-scroll">
          <div id="calendarRoot"></div>
        </div>
      </div>

      <!-- STAFF MANAGEMENT TAB -->
      <div id="staffTab" class="tab-pane">
        <div class="data-backup-section">
          <h4>ğŸ’¾ Data Backup & Restore</h4>
          <p>Export your data before deploying, then import it back to restore staff and shifts.</p>
          <div class="data-backup-buttons">
            <button class="btn-export" onclick="exportData()">ğŸ“¥ Export Data</button>
            <button class="btn-import" onclick="openImportDialog()">ğŸ“¤ Import Data</button>
          </div>
        </div>
        <div class="staff-mgmt">
          <h3>Add New Staff Member</h3>
          <div class="add-form">
            <div class="frow">
              <input type="text" id="newUsername" placeholder="Username">
              <input type="text" id="newFullName" placeholder="Full Name">
              <select id="newJobTitle">
                <option value="Caregiver">Caregiver</option>
                <option value="House Manager">House Manager</option>
                <option value="Trainer">Trainer</option>
                <option value="Admin">Admin</option>
              </select>
              <button class="add-s-btn" onclick="addStaff()">Add Staff</button>
            </div>
          </div>
          <h3>Current Staff</h3>
          <div id="staffList"></div>
        </div>
      </div>

      <!-- APPROVALS TAB -->
      <div id="approvalsTab" class="tab-pane">
        <div class="approvals-section">
          <h3>Pending Approvals</h3>
          <div id="approvalsList"></div>
          <div id="noApprovalsMsg" class="empty-state">âœ… No pending approvals</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• STAFF VIEW â•â•â• -->
    <div id="staffDashboard" class="hidden">

      <!-- Action buttons â€” always visible at top -->
      <div class="staff-action-bar">
        <button class="staff-action-btn btn-request" onclick="openRequestDialog()">
          <span class="sab-icon">ğŸ“‹</span>
          <span class="sab-label">Request Shift / Trade</span>
        </button>
        <button class="staff-action-btn btn-emergency" onclick="openEmergencyDialog()">
          <span class="sab-icon">ğŸš¨</span>
          <span class="sab-label">Emergency / Issue</span>
        </button>
        <button class="staff-action-btn btn-contact" onclick="openContactDialog()">
          <span class="sab-icon">ğŸ“</span>
          <span class="sab-label">Contact</span>
        </button>
        <button class="staff-action-btn btn-settings" onclick="openSettingsDialog()">
          <span class="sab-icon">âš™ï¸</span>
          <span class="sab-label">Settings</span>
        </button>
      </div>

      <!-- Stats dashboard -->
      <div class="dashboard-card">
        <h3>ğŸ“Š Your Dashboard</h3>
        <div id="dashboardContent"></div>
      </div>

      <!-- Staff calendar nav + grid -->
      <div class="cal-nav" style="margin-top:16px;">
        <div class="cal-nav-left">
          <button class="nav-arrow" onclick="navPrev()">â—„</button>
          <span class="cal-title" id="calTitleStaff"></span>
          <button class="nav-arrow" onclick="navNext()">â–º</button>
        </div>
        <div class="view-toggle">
          <button class="v-btn active" id="vWeekStaff" onclick="setView('week')">Week</button>
          <button class="v-btn" id="vMonthStaff" onclick="setView('month')">Month</button>
        </div>
      </div>
      <div class="cal-scroll" style="margin-top:8px;">
        <div id="calendarRootStaff"></div>
      </div>

    </div>

  </div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" class="ov">
  <div class="modal">
    <h3>ğŸ”’ Change Password</h3>
    <div class="fg">
      <label>New Password (min 6 characters)</label>
      <input type="password" id="newPassword" placeholder="Enter new password">
    </div>
    <div class="mbtn-row">
      <button class="mc" onclick="closePasswordModal()">Cancel</button>
      <button class="mok" onclick="savePassword()">Change Password</button>
    </div>
  </div>
</div>

<!-- Edit Staff Modal -->
<div id="editStaffModal" class="ov">
  <div class="modal">
    <h3>âœï¸ Edit Staff Member</h3>
    <input type="hidden" id="editStaffId">
    <div class="fg">
      <label>Full Name</label>
      <input type="text" id="editFullName">
    </div>
    <div class="fg">
      <label>Job Title</label>
      <select id="editJobTitle">
        <option value="Caregiver">Caregiver</option>
        <option value="Nurse">Nurse</option>
        <option value="House Manager">House Manager</option>
      </select>
    </div>
    <div class="fg">
      <label>Tile Color</label>
      <input type="hidden" id="editTileColor" value="#f5f5f5">
      <div class="swatch-grid" id="swatchGrid"></div>
    </div>
    <div class="fg">
      <label>Text Color</label>
      <select id="editTextColor">
        <option value="black">Black</option>
        <option value="white">White</option>
      </select>
    </div>
    <div class="fg">
      <label>Telegram ID (for notifications)</label>
      <input type="text" id="editTelegramId" placeholder="Leave blank if not linked">
    </div>
    <div class="mbtn-row">
      <button class="mc" onclick="closeEditStaffModal()">Cancel</button>
      <button class="mok" onclick="saveStaffEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Loading Indicator -->
<div id="loading" class="loading-overlay hidden">
  <div class="spinner"></div>
</div>


<!-- Shift Generator Modal -->
<div id="shiftGeneratorModal" class="modal-overlay" style="display:none;">
  <div class="modal-content shift-gen-modal">
    <h3>ğŸ—“ï¸ Shift Generator</h3>
    
    <!-- Tab Selection -->
    <div class="gen-tabs">
      <button class="gen-tab active" onclick="switchGenTab('create')">Create Shifts</button>
      <button class="gen-tab" onclick="switchGenTab('copy')">Copy Shifts</button>
      <button class="gen-tab" onclick="switchGenTab('templates')">Edit Templates</button>
    </div>
    
    <!-- CREATE SHIFTS TAB -->
    <div id="genTabCreate" class="gen-tab-content active">
      <h4>Create New Shifts</h4>
      
      <div class="gen-section">
        <label>Date Range:</label>
        <div class="date-range">
          <input type="date" id="genStartDate" class="inp">
          <span>to</span>
          <input type="date" id="genEndDate" class="inp">
        </div>
      </div>
      
      <div class="gen-section">
        <label>Which Days:</label>
        <div class="day-checkboxes">
          <label><input type="checkbox" id="daySun" checked> Sun</label>
          <label><input type="checkbox" id="dayMon" checked> Mon</label>
          <label><input type="checkbox" id="dayTue" checked> Tue</label>
          <label><input type="checkbox" id="dayWed" checked> Wed</label>
          <label><input type="checkbox" id="dayThu" checked> Thu</label>
          <label><input type="checkbox" id="dayFri" checked> Fri</label>
          <label><input type="checkbox" id="daySat" checked> Sat</label>
        </div>
      </div>
      
      <div class="gen-section">
        <label>Which Shift Types:</label>
        <div class="shift-checkboxes">
          <label><input type="checkbox" id="shiftMorning" checked> ğŸŒ… Morning</label>
          <label><input type="checkbox" id="shiftAfternoon" checked> ğŸŒ† Afternoon</label>
          <label><input type="checkbox" id="shiftOvernight" checked> ğŸŒ™ Overnight</label>
        </div>
      </div>
      
      <div class="gen-section">
        <label>Assignment Pattern:</label>
        <select id="genPattern" class="inp" onchange="togglePatternOptions()">
          <option value="open">Leave as Open Shifts</option>
          <option value="specific">Assign to Specific Staff</option>
          <option value="rotate">Rotate Through Staff</option>
        </select>
        
        <div id="specificStaffOption" class="pattern-option" style="display:none;">
          <label>Assign all to:</label>
          <select id="genSpecificStaff" class="inp">
            <option value="">-- Select Staff --</option>
          </select>
        </div>
        
        <div id="rotateStaffOption" class="pattern-option" style="display:none;">
          <label>Rotation Order (drag to reorder):</label>
          <div id="rotationList" class="rotation-list"></div>
        </div>
      </div>
      
      <div class="gen-preview">
        <strong>Preview:</strong> <span id="genPreviewText">Select options above</span>
      </div>
      
      <div class="modal-actions">
        <button class="b-can" onclick="closeShiftGenerator()">Cancel</button>
        <button class="b-pri" onclick="generateShifts()">Generate Shifts</button>
      </div>
    </div>
    
    <!-- COPY SHIFTS TAB -->
    <div id="genTabCopy" class="gen-tab-content">
      <h4>Copy Existing Shifts</h4>
      
      <div class="gen-section">
        <label>Copy From:</label>
        <div class="copy-from-options">
          <label><input type="radio" name="copyFrom" value="day" checked> Single Day</label>
          <label><input type="radio" name="copyFrom" value="week"> Full Week</label>
          <label><input type="radio" name="copyFrom" value="month"> Full Month</label>
        </div>
        <input type="date" id="copySourceDate" class="inp">
      </div>
      
      <div class="gen-section">
        <label>Copy To:</label>
        <input type="date" id="copyTargetDate" class="inp">
        <small>Shifts will be copied starting from this date</small>
      </div>
      
      <div class="gen-section">
        <label>Options:</label>
        <label><input type="checkbox" id="copyKeepAssignments" checked> Keep staff assignments</label>
        <label><input type="checkbox" id="copySkipExisting" checked> Skip if shift already exists</label>
      </div>
      
      <div class="gen-preview">
        <strong>Preview:</strong> <span id="copyPreviewText">Select dates above</span>
      </div>
      
      <div class="modal-actions">
        <button class="b-can" onclick="closeShiftGenerator()">Cancel</button>
        <button class="b-pri" onclick="copyShifts()">Copy Shifts</button>
      </div>
    </div>
    
    <!-- EDIT TEMPLATES TAB -->
    <div id="genTabTemplates" class="gen-tab-content">
      <h4>Edit Shift Templates</h4>
      
      <div class="template-editor">
        <div class="template-item">
          <h5>ğŸŒ… Morning Shift</h5>
          <label>Label:</label>
          <input type="text" id="tmplMorningLabel" class="inp" value="Morning">
          <label>Time:</label>
          <input type="text" id="tmplMorningTime" class="inp" value="7:00 AM â€“ 3:00 PM">
          <label>Hours:</label>
          <input type="number" id="tmplMorningHours" class="inp" value="8.0" step="0.5">
        </div>
        
        <div class="template-item">
          <h5>ğŸŒ† Afternoon Shift</h5>
          <label>Label:</label>
          <input type="text" id="tmplAfternoonLabel" class="inp" value="Afternoon">
          <label>Time:</label>
          <input type="text" id="tmplAfternoonTime" class="inp" value="3:00 PM â€“ 7:00 PM">
          <label>Hours:</label>
          <input type="number" id="tmplAfternoonHours" class="inp" value="4.0" step="0.5">
        </div>
        
        <div class="template-item">
          <h5>ğŸŒ™ Overnight Shift</h5>
          <label>Label:</label>
          <input type="text" id="tmplOvernightLabel" class="inp" value="Overnight">
          <label>Time:</label>
          <input type="text" id="tmplOvernightTime" class="inp" value="7:00 PM â€“ 7:00 AM">
          <label>Hours:</label>
          <input type="number" id="tmplOvernightHours" class="inp" value="12.0" step="0.5">
        </div>
      </div>
      
      <p class="template-note">âš ï¸ Note: Templates are saved locally in your browser. They don't sync across devices.</p>
      
      <div class="modal-actions">
        <button class="b-can" onclick="closeShiftGenerator()">Cancel</button>
        <button class="b-pri" onclick="saveTemplates()">Save Templates</button>
      </div>
    </div>
    
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PICK MODE BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="pickModeBar" class="pick-mode-bar">
  <span id="pickModeHint">Select a shiftâ€¦</span>
  <button onclick="exitPickMode()">âœ• Cancel</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REQUEST SHIFT/TRADE DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="requestDialog" class="ov">
  <div class="modal">
    <h3>ğŸ“‹ Request Shift or Trade</h3>
    <p style="color:#666;font-size:13px;margin-bottom:20px;">What would you like to do?</p>
    <div class="request-options">
      <button class="request-option-btn" onclick="startShiftRequest()">
        <div class="rob-icon">â•</div>
        <div class="rob-title">Request an Open Shift</div>
        <div class="rob-desc">Tap an available (grey) shift on the calendar to request admin approval</div>
      </button>
      <button class="request-option-btn" onclick="startTradeRequest()">
        <div class="rob-icon">ğŸ”„</div>
        <div class="rob-title">Trade a Shift</div>
        <div class="rob-desc">Swap one of your shifts with another staff member â€” requires their approval + admin sign-off</div>
      </button>
    </div>
    <div class="mbtn-row" style="margin-top:16px;">
      <button class="mc" onclick="closeRequestDialog()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMERGENCY DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="emergencyDialog" class="ov">
  <div class="modal">
    <h3>ğŸš¨ Emergency Report</h3>

    <!-- Type selector -->
    <div id="emergencyTypeSelect" class="show">
      <p style="color:#666;font-size:13px;margin-bottom:20px;">Select the type of report:</p>
      <div class="request-options">
        <button class="request-option-btn emerg-btn" onclick="showAbsenceForm()">
          <div class="rob-icon">ğŸ¥</div>
          <div class="rob-title">Report Absence</div>
          <div class="rob-desc">Cannot make your shift â€” notifies House Manager, Admin, and current shift staff</div>
        </button>
        <button class="request-option-btn emerg-btn" onclick="showIssueForm()">
          <div class="rob-icon">âš ï¸</div>
          <div class="rob-title">Report an Issue</div>
          <div class="rob-desc">Safety, maintenance, or other concern â€” notifies House Manager by default</div>
        </button>
      </div>
      <div class="mbtn-row" style="margin-top:16px;">
        <button class="mc" onclick="closeEmergencyDialog()">Close</button>
      </div>
    </div>

    <!-- Absence form -->
    <div id="absenceForm">
      <div class="fg">
        <label>Which shift are you unable to make?</label>
        <select id="absenceShiftSelect" class="inp-full">
          <option value="">-- Select your shift --</option>
        </select>
      </div>
      <div class="fg">
        <label>Reason / Details <span style="color:#dc3545;">*</span></label>
        <textarea id="absenceReason" rows="3" placeholder="Describe the reason for absenceâ€¦" style="width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:13px;resize:vertical;"></textarea>
      </div>
      <div class="fg">
        <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
          <input type="checkbox" id="absenceOnDutyCheck">
          I am currently on duty and became ill / unable to continue
        </label>
        <div style="font-size:11px;color:#888;margin-top:4px;">Checking this notifies House Manager and Admin only (not other shift staff)</div>
      </div>
      <div class="mbtn-row">
        <button class="mc" onclick="backToEmergencyTypeSelect()">â† Back</button>
        <button class="mok" style="background:#dc3545;" id="submitAbsenceBtn" onclick="submitAbsence()">Submit Report</button>
      </div>
    </div>

    <!-- Issue form -->
    <div id="issueForm">
      <div class="fg">
        <label>Issue Details <span style="color:#dc3545;">*</span></label>
        <textarea id="issueDetails" rows="4" placeholder="Describe the issue in detailâ€¦" style="width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:13px;resize:vertical;"></textarea>
      </div>
      <div class="fg">
        <label style="font-weight:600;color:#495057;font-size:13px;">Who should be notified?</label>
        <div style="margin-top:8px;padding:10px;background:#fff3cd;border-radius:6px;font-size:12px;color:#856404;margin-bottom:8px;">
          ğŸ  House Manager is always notified (required)
        </div>
        <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
          <input type="checkbox" id="issueNotifyAdmin">
          Also notify Admin
        </label>
      </div>
      <div class="mbtn-row">
        <button class="mc" onclick="backToEmergencyTypeSelect()">â† Back</button>
        <button class="mok" style="background:#dc3545;" id="submitIssueBtn" onclick="submitIssue()">Submit Issue</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTACT DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="contactDialog" class="ov">
  <div class="modal contact-modal">
    <h3>ğŸ“ Contact</h3>
    <div id="contactOptions"></div>
    <div class="mbtn-row" style="margin-top:16px;">
      <button class="mc" onclick="closeContactDialog()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS DIALOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settingsDialog" class="ov">
  <div class="modal">
    <h3>âš™ï¸ My Settings</h3>
    <div class="fg">
      <label>Full Name</label>
      <input type="text" id="settingsFullName" placeholder="Your full name">
    </div>
    <div class="fg">
      <label>Phone Number</label>
      <input type="tel" id="settingsPhone" placeholder="e.g. 555-123-4567">
    </div>
    <div class="fg">
      <label>Telegram ID</label>
      <input type="text" id="settingsTelegramId" placeholder="Your Telegram ID (from @YourBot)" readonly style="background:#f8f9fa;cursor:not-allowed;">
      <div style="font-size:11px;color:#888;margin-top:4px;">Ask your admin to link your Telegram ID â€” message your bot first to get it</div>
    </div>
    <hr style="margin:16px 0;border:none;border-top:1px solid #eee;">
    <div class="fg">
      <label>New Password (leave blank to keep current)</label>
      <input type="password" id="settingsNewPassword" placeholder="New password (min 6 chars)">
    </div>
    <div class="fg">
      <label>Confirm New Password</label>
      <input type="password" id="settingsConfirmPassword" placeholder="Confirm new password">
    </div>
    <div class="mbtn-row">
      <button class="mc" onclick="closeSettingsDialog()">Cancel</button>
      <button class="mok" id="saveSettingsBtn" onclick="saveSettings()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Import Data Modal -->
<div id="importDataModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h3>ğŸ“¤ Import Data from Backup</h3>
    
    <div class="import-instructions">
      <p>Select a backup file (JSON) to restore staff and shifts.</p>
      <p><strong>This will:</strong></p>
      <ul>
        <li>âœ… Add missing staff members</li>
        <li>âœ… Add missing shifts</li>
        <li>âœ… Restore shift templates</li>
        <li>âš ï¸ Skip existing data (no duplicates)</li>
      </ul>
    </div>
    
    <input type="file" id="importFileInput" accept=".json" onchange="handleImportFileSelect(event)">
    
    <div id="importPreview"></div>
    
    <div class="modal-actions">
      <button class="b-can" onclick="closeImportDialog()">Cancel</button>
      <button class="b-pri" id="importButton" onclick="confirmImport()" disabled>Import Data</button>
    </div>
  </div>
</div>

<script src="/app.js"></script>
</body>
</html>
